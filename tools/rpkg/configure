#!/bin/sh

set -e
set -x

cd `dirname $0`

if [ ! -f "../../scripts/amalgamation.py" ]; then
	echo "Could find neither the amalgamation build script"
	exit 1
fi

rm -rf src/duckdb/include
mkdir -p src/duckdb
cp -r ../../src/include src/duckdb/src-include

# R issues a warning for .hpp files, use .h to silence it
(cd ../.. && python extension/parquet/parquet_amalgamation.py --source=tools/rpkg/src/parquet-extension.cpp --header=tools/rpkg/src/parquet-extension.h && rm -f tools/rpkg/src/duckdb/include/utf8proc_wrapper.hpp && touch tools/rpkg/src/duckdb/src-include/utf8proc_wrapper.hpp )

cd src/duckdb
cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=`pwd` ../../../..
